int timeLim = 1500, timeTaken = 0, levelClear;
char bopit [] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xB0, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x00,
0x00, 0x00, 0x00, 0x08, 0x14, 0x08, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
0x80, 0x80, 0x00, 0x00, 0x00, 0x10, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0,
0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
0xC0, 0xC0, 0xC0, 0x00, 0x00, 0xE0, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x40, 0xB0, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10,
0x38, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xE1, 0xE1, 0xE1, 0xF3, 0xFF, 0xFF,
0xDE, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFC, 0xFF, 0x0F, 0x07, 0x03, 0x41, 0xE1, 0xF1, 0xE1, 0x41,
0x03, 0x07, 0x0F, 0xFF, 0xFC, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xE1, 0xE1, 0xE1, 0xF3,
0x7F, 0x7F, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0xFF,
0xFF, 0xFF, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x01, 0x01,
0x01, 0x01, 0x01, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x70, 0x70, 0x70, 0x70, 0x79, 0x3F,
0x1F, 0x0F, 0x00, 0x00, 0x00, 0x01, 0x07, 0x1F, 0x1E, 0x3C, 0x38, 0x70, 0x70, 0x71, 0x70, 0x70,
0x38, 0x3C, 0x1E, 0x1F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xB0, 0x40, 0x00, 0x00, 0x70, 0x70, 0x7F,
0x7F, 0x7F, 0x70, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x73, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x6C,
0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x05, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x10, 0x28, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x04, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x08, 0x14, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00
};

typedef enum Command
{
  Shake = 0,
  PressBTN2 = 1,
  PressBTN3 = 2,
  PressBTN4 = 3,
  Switch1 = 4,
  Switch2 = 5,
} Command;

struct GameState {
  int score;
  bool isShaking;
  enum Command playerCommand;
} activeGame;


void GameUIInit() {
  gameInputState = { 0 };
  activeGame = { 0 };
  timeLim = 1500, timeTaken = 0, levelClear=0;

}



void lose () {
  OrbitOledClearBuffer();
  OrbitOledMoveTo(0, 0);
  OrbitOledDrawString("Game Over!");
  OrbitOledMoveTo(0, 10);
  OrbitOledDrawString("Score: ");
  String strScore = String(activeGame.score);
  char score[1024];
  strcpy(score, strScore.c_str());
  OrbitOledDrawString(score);
  OrbitOledUpdate();
  delay (5000);

  pageMain = 0;
  viewMenu = 1;
  GameUIInit();
}

bool shaking ;
void shakeDetect() {

  ShakeTick();

  if (ShakeIsShaking()) {
    levelClear = 1;
    shaking = true;
    delay (100);

  }
}

void btnPress(int b) {
  uiInputTick();
  if (gameInputState.buttons[b].isRising) {
    OrbitOledClearBuffer();
    OrbitOledUpdate();
    levelClear = 1;
    activeGame.score++;
  
  }
}


void switchChanged(int b, bool currentState) {
  uiInputTick();
  if (gameInputState.switches[b]!=currentState) {
    OrbitOledClearBuffer();
    OrbitOledUpdate();
    levelClear = 1;
    activeGame.score++;
  
  }
}

void bopIt() {
  activeGame.playerCommand = (enum Command)(rand() % 6);
  uiInputTick();
  levelClear = 0;
  stat.happiness++;

  switch (activeGame.playerCommand) {
    case Shake: {
        
        OrbitOledMoveTo(0, 0);
        OrbitOledClearBuffer();
        OrbitOledDrawString("Shake");
        OrbitOledUpdate();

        while (timeTaken < timeLim && levelClear == 0 && shaking == false) {
          ShakeInit();
          shakeDetect();
          delay (1);
          timeTaken ++;
        }

        if (shaking) {
          activeGame.score++;
          

          shaking = false;
        }
        if (timeTaken >= timeLim )
        { 
          lose ();
        }
        if (levelClear == 1) {
          timeTaken = 0;
        }
        break;
      }
    case PressBTN2:

      {
        OrbitOledMoveTo(0, 0);
        OrbitOledDrawString("Press Btn 2");
        OrbitOledUpdate();
        while (timeTaken < timeLim && levelClear == 0) {
          btnPress (1);
          delay (1);
          timeTaken ++;
        }

        if (timeTaken >= timeLim )
        { 
          lose ();
        }
        if (levelClear == 1) {
          timeTaken = 0;
        }
        break;
      }
    case PressBTN3:

      {
        OrbitOledMoveTo(0, 0);
        OrbitOledDrawString("Press Btn 3");
        OrbitOledUpdate();
        while (timeTaken < timeLim && levelClear == 0) {
          btnPress (2);
          delay (1);
          timeTaken ++;
        }

        if (timeTaken >= timeLim )
        { 
          lose ();
        }
        if (levelClear == 1) {
          timeTaken = 0;
        }
        break;
      }
    case PressBTN4:
      {
        OrbitOledMoveTo(0, 0);
        OrbitOledDrawString("Press Btn 4");
        OrbitOledUpdate();
        while (timeTaken < timeLim && levelClear == 0) {
          btnPress (3);
          delay (1);
          timeTaken ++;
        }

        if (timeTaken >= timeLim )
        {
          lose ();
        }
        if (levelClear == 1) {
          timeTaken = 0;
        }
        break;
      }

    case Switch1: {
      
        OrbitOledMoveTo(0, 0);
        OrbitOledDrawString("Change Switch 1");
        OrbitOledUpdate();
         int currentState = gameInputState.switches[0] ;
       
        while (timeTaken < timeLim && levelClear == 0) {
          switchChanged (0, currentState);
          delay (1);
          timeTaken ++;
        }

        if (timeTaken >= timeLim )
        { 
          lose ();
        }
        if (levelClear == 1) {
          timeTaken = 0;

          
        }
        break;
      }
    case Switch2: {
        OrbitOledMoveTo(0, 0);
        OrbitOledDrawString("Change Switch 2");
        OrbitOledUpdate();
         int currentState = gameInputState.switches[1] ;
         
        while (timeTaken < timeLim && levelClear == 0) {
          switchChanged (1, currentState);
          delay (1);
          timeTaken ++;
        }

        if (timeTaken >= timeLim )
        { 
          lose ();
        }
        if (levelClear == 1) {
          timeTaken = 0;          
        }
        break;
      }
  }
 
  OrbitOledUpdate();

}




